name: CI/CD Pipeline for JavaScript Math Utils

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: ðŸ” Validate Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate JavaScript syntax
      run: |
        echo "Validating JavaScript syntax..."
        if node -c mathUtils.js; then
          echo "âœ… JavaScript syntax is valid"
        else
          echo "âŒ JavaScript syntax error"
          exit 1
        fi

    - name: Check required files
      run: |
        echo "Checking project structure..."
        if [ -f "mathUtils.js" ] && [ -f "package.json" ]; then
          echo "âœ… Required files present"
        else
          echo "âŒ Missing required files"
          exit 1
        fi

  test-multi-platform:
    name: ðŸ§ª Test on Multiple Platforms
    needs: validate
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16.x, 18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Display environment info
      run: |
        echo "Operating System: ${{ matrix.os }}"
        echo "Node.js Version: $(node --version)"
        echo "Running directory: $(pwd)"

    - name: Run unit tests
      run: |
        echo "Running comprehensive tests..."
        node mathUtils.js test
        echo "âœ… All tests passed on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}"

    - name: Test individual functions
      run: |
        echo "Testing individual math functions..."
        node -e "
          const math = require('./mathUtils.js');
          
          // Test basic arithmetic
          console.log('Basic Arithmetic:');
          console.log('  2 + 3 =', math.add(2, 3));
          console.log('  10 - 4 =', math.subtract(10, 4));
          console.log('  5 * 6 =', math.multiply(5, 6));
          console.log('  15 / 3 =', math.divide(15, 3));
          
          // Test advanced functions
          console.log('Advanced Functions:');
          console.log('  factorial(5) =', math.factorial(5));
          console.log('  power(2, 8) =', math.power(2, 8));
          console.log('  fibonacci(10) =', math.fibonacci(10));
          console.log('  isPrime(17) =', math.isPrime(17));
          
          // Test statistical functions
          console.log('Statistical Functions:');
          console.log('  average([1,2,3,4,5]) =', math.average([1,2,3,4,5]));
          console.log('  median([1,3,2]) =', math.median([1,3,2]));
          
          console.log('âœ… All functions working correctly');
        "

  security-audit:
    name: ðŸ”’ Security Audit
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Security checks
      run: |
        echo "Running security audit..."
        
        # Check for dangerous patterns
        echo "1. Checking for eval usage..."
        if grep -q "eval(" mathUtils.js; then
          echo "âš ï¸  Warning: eval() found in code"
          exit 1
        else
          echo "âœ… No eval() usage detected"
        fi
        
        echo "2. Checking for Function constructor..."
        if grep -q "Function(" mathUtils.js; then
          echo "âš ï¸  Warning: Function constructor found"
          exit 1
        else
          echo "âœ… No Function constructor usage"
        fi
        
        echo "3. Checking for unsafe patterns..."
        if grep -q "innerHTML\\|innerHTML\\|outerHTML" mathUtils.js; then
          echo "âš ï¸  Warning: Potential unsafe HTML manipulation"
          exit 1
        else
          echo "âœ… No unsafe HTML patterns"
        fi
        
        echo "âœ… Security audit passed"

  build-package:
    name: ðŸ“¦ Build Package
    needs: [test-multi-platform, security-audit]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Create build directory
      run: |
        echo "Creating build package..."
        mkdir -p dist
        cp mathUtils.js dist/
        cp package.json dist/
        
        # Create a simple README for the build
        cat > dist/README.md << EOF
        # Math Utils Library
        
        ## Build Information
        - **Build Date**: $(date)
        - **Commit**: ${{ github.sha }}
        - **Node.js Version**: $(node --version)
        - **Status**: âœ… CI/CD Verified
        
        ## Usage
        \`\`\`javascript
        const math = require('./mathUtils.js');
        console.log(math.add(2, 3)); // 5
        \`\`\`
        
        ## Test Results
        - âœ… Multi-OS Testing (Linux, Windows, macOS)
        - âœ… Node.js Compatibility (16.x, 18.x, 20.x)
        - âœ… Security Audit Passed
        - âœ… All Unit Tests Passed
        EOF
        
        echo "âœ… Build directory created"

    - name: Create distribution archive
      run: |
        echo "Creating distribution package..."
        cd dist
        tar -czf ../math-utils-package.tar.gz .
        echo "âœ… Distribution package created: math-utils-package.tar.gz"
        
        # Show package contents
        echo "Package contents:"
        tar -tzf ../math-utils-package.tar.gz

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: math-utils-build
        path: |
          math-utils-package.tar.gz
          dist/
        retention-days: 30

  deployment-check:
    name: ðŸš€ Deployment Ready
    needs: build-package
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: math-utils-build
        path: ./downloaded-build

    - name: Verify deployment package
      run: |
        echo "Verifying deployment package..."
        cd downloaded-build
        
        # Extract and test the package
        tar -xzf math-utils-package.tar.gz
        echo "Package contents:"
        ls -la
        
        # Test the built package
        echo "Testing the built package..."
        node -e "
          const math = require('./mathUtils.js');
          console.log('âœ… Package test: 7 + 8 =', math.add(7, 8));
        "
        
        echo "âœ… Deployment package verified and ready"

    - name: Create deployment report
      run: |
        cat > deployment-report.md << EOF
        # Deployment Report - Math Utils Library
        
        ## Build Summary
        - **Build ID**: ${{ github.run_id }}
        - **Commit**: ${{ github.sha }}
        - **Timestamp**: $(date -u)
        - **Status**: âœ… READY FOR DEPLOYMENT
        
        ## Test Coverage
        - Operating Systems: Ubuntu, Windows, macOS âœ…
        - Node.js Versions: 16.x, 18.x, 20.x âœ…
        - Security Audit: Passed âœ…
        - All Unit Tests: Passed âœ…
        
        ## Artifacts
        - \`math-utils-package.tar.gz\` - Complete distribution package
        - \`mathUtils.js\` - Main library file
        - \`package.json\` - Package configuration
        
        ## Next Steps
        The package is ready for deployment. Download the artifacts from GitHub Actions.
        EOF
        
        echo "âœ… Deployment report created"

    - name: Upload deployment report
      uses: actions/upload-artifact@v4
      with:
        name: deployment-report
        path: deployment-report.md
        retention-days: 30

  success-notification:
    name: âœ… Pipeline Success
    needs: [test-multi-platform, security-audit, build-package, deployment-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Pipeline status
      run: |
        if [ "${{ needs.test-multi-platform.result }}" = "success" ] && \
           [ "${{ needs.security-audit.result }}" = "success" ] && \
           [ "${{ needs.build-package.result }}" = "success" ]; then
          echo "ðŸŽ‰ CI/CD PIPELINE COMPLETED SUCCESSFULLY!"
          echo "ðŸ“Š Test Results:"
          echo "   - Multi-Platform Testing: âœ… PASSED"
          echo "   - Security Audit: âœ… PASSED" 
          echo "   - Build Package: âœ… CREATED"
          echo "   - Deployment Ready: âœ… VERIFIED"
          echo ""
          echo "ðŸ”— View artifacts in GitHub Actions"
          echo "ðŸ“¦ Download build: math-utils-build artifact"
          echo "ðŸ“„ View report: deployment-report artifact"
        else
          echo "âŒ Pipeline failed or skipped"
          echo "Check individual job status for details"
        fi